import{d as wt}from"./BruXBgQu.js";import"./BmK2dJuU.js";async function fe(i,e={},t){return window.__TAURI_INTERNALS__.invoke(i,e,t)}class we{constructor(e){this.path=e}static async load(e){const t=await fe("plugin:sql|load",{db:e});return new we(t)}static get(e){return new we(e)}async execute(e,t){const[s,r]=await fe("plugin:sql|execute",{db:this.path,query:e,values:t??[]});return{lastInsertId:r,rowsAffected:s}}async select(e,t){return await fe("plugin:sql|select",{db:this.path,query:e,values:t??[]})}async close(e){return await fe("plugin:sql|close",{db:e})}}const d=Symbol.for("drizzle:entityKind");function h(i,e){if(!i||typeof i!="object")return!1;if(i instanceof e)return!0;if(!Object.prototype.hasOwnProperty.call(e,d))throw new Error(`Class "${e.name??"<unknown>"}" doesn't look like a Drizzle entity. If this is incorrect and the class is provided by Drizzle, please report this as a bug.`);let t=Object.getPrototypeOf(i).constructor;if(t)for(;t;){if(d in t&&t[d]===e[d])return!0;t=Object.getPrototypeOf(t)}return!1}class St{static[d]="ConsoleLogWriter";write(e){console.log(e)}}class Qt{static[d]="DefaultLogger";writer;constructor(e){this.writer=e?.writer??new St}logQuery(e,t){const s=t.map(n=>{try{return JSON.stringify(n)}catch{return String(n)}}),r=s.length?` -- params: [${s.join(", ")}]`:"";this.writer.write(`Query: ${e}${r}`)}}class Lt{static[d]="NoopLogger";logQuery(){}}const G=Symbol.for("drizzle:Name"),ge=Symbol.for("drizzle:Schema"),Oe=Symbol.for("drizzle:Columns"),Ve=Symbol.for("drizzle:ExtraConfigColumns"),ve=Symbol.for("drizzle:OriginalName"),qe=Symbol.for("drizzle:BaseName"),Se=Symbol.for("drizzle:IsAlias"),Ue=Symbol.for("drizzle:ExtraConfigBuilder"),Nt=Symbol.for("drizzle:IsDrizzleTable");class m{static[d]="Table";static Symbol={Name:G,Schema:ge,OriginalName:ve,Columns:Oe,ExtraConfigColumns:Ve,BaseName:qe,IsAlias:Se,ExtraConfigBuilder:Ue};[G];[ve];[ge];[Oe];[Ve];[qe];[Se]=!1;[Nt]=!0;[Ue]=void 0;constructor(e,t,s){this[G]=this[ve]=e,this[ge]=t,this[qe]=s}}function re(i){return i[G]}function le(i){return`${i[ge]??"public"}.${i[G]}`}class B{constructor(e,t){this.table=e,this.config=t,this.name=t.name,this.keyAsName=t.keyAsName,this.notNull=t.notNull,this.default=t.default,this.defaultFn=t.defaultFn,this.onUpdateFn=t.onUpdateFn,this.hasDefault=t.hasDefault,this.primary=t.primaryKey,this.isUnique=t.isUnique,this.uniqueName=t.uniqueName,this.uniqueType=t.uniqueType,this.dataType=t.dataType,this.columnType=t.columnType,this.generated=t.generated,this.generatedIdentity=t.generatedIdentity}static[d]="Column";name;keyAsName;primary;notNull;default;defaultFn;onUpdateFn;hasDefault;isUnique;uniqueName;uniqueType;dataType;columnType;enumValues=void 0;generated=void 0;generatedIdentity=void 0;config;mapFromDriverValue(e){return e}mapToDriverValue(e){return e}shouldDisableInsert(){return this.config.generated!==void 0&&this.config.generated.type!=="byDefault"}}class $t{static[d]="ColumnBuilder";config;constructor(e,t,s){this.config={name:e,keyAsName:e==="",notNull:!1,default:void 0,hasDefault:!1,primaryKey:!1,isUnique:!1,uniqueName:void 0,uniqueType:void 0,dataType:t,columnType:s,generated:void 0}}$type(){return this}notNull(){return this.config.notNull=!0,this}default(e){return this.config.default=e,this.config.hasDefault=!0,this}$defaultFn(e){return this.config.defaultFn=e,this.config.hasDefault=!0,this}$default=this.$defaultFn;$onUpdateFn(e){return this.config.onUpdateFn=e,this.config.hasDefault=!0,this}$onUpdate=this.$onUpdateFn;primaryKey(){return this.config.primaryKey=!0,this.config.notNull=!0,this}setName(e){this.config.name===""&&(this.config.name=e)}}const Je=Symbol.for("drizzle:isPgEnum");function Ct(i){return!!i&&typeof i=="function"&&Je in i&&i[Je]===!0}class D{static[d]="Subquery";constructor(e,t,s,r=!1,n=[]){this._={brand:"Subquery",sql:e,selectedFields:t,alias:s,isWith:r,usedTables:n}}}class st extends D{static[d]="WithSubquery"}const Tt={startActiveSpan(i,e){return e()}},x=Symbol.for("drizzle:ViewBaseConfig");function it(i){return i!=null&&typeof i.getSQL=="function"}function Bt(i){const e={sql:"",params:[]};for(const t of i)e.sql+=t.sql,e.params.push(...t.params),t.typings?.length&&(e.typings||(e.typings=[]),e.typings.push(...t.typings));return e}class q{static[d]="StringChunk";value;constructor(e){this.value=Array.isArray(e)?e:[e]}getSQL(){return new p([this])}}class p{constructor(e){this.queryChunks=e;for(const t of e)if(h(t,m)){const s=t[m.Symbol.Schema];this.usedTables.push(s===void 0?t[m.Symbol.Name]:s+"."+t[m.Symbol.Name])}}static[d]="SQL";decoder=rt;shouldInlineParams=!1;usedTables=[];append(e){return this.queryChunks.push(...e.queryChunks),this}toQuery(e){return Tt.startActiveSpan("drizzle.buildSQL",t=>{const s=this.buildQueryFromSourceParams(this.queryChunks,e);return t?.setAttributes({"drizzle.query.text":s.sql,"drizzle.query.params":JSON.stringify(s.params)}),s})}buildQueryFromSourceParams(e,t){const s=Object.assign({},t,{inlineParams:t.inlineParams||this.shouldInlineParams,paramStartIndex:t.paramStartIndex||{value:0}}),{casing:r,escapeName:n,escapeParam:o,prepareTyping:l,inlineParams:c,paramStartIndex:f}=s;return Bt(e.map(u=>{if(h(u,q))return{sql:u.value.join(""),params:[]};if(h(u,Fe))return{sql:n(u.value),params:[]};if(u===void 0)return{sql:"",params:[]};if(Array.isArray(u)){const y=[new q("(")];for(const[b,N]of u.entries())y.push(N),b<u.length-1&&y.push(new q(", "));return y.push(new q(")")),this.buildQueryFromSourceParams(y,s)}if(h(u,p))return this.buildQueryFromSourceParams(u.queryChunks,{...s,inlineParams:c||u.shouldInlineParams});if(h(u,m)){const y=u[m.Symbol.Schema],b=u[m.Symbol.Name];return{sql:y===void 0||u[Se]?n(b):n(y)+"."+n(b),params:[]}}if(h(u,B)){const y=r.getColumnCasing(u);if(t.invokeSource==="indexes")return{sql:n(y),params:[]};const b=u.table[m.Symbol.Schema];return{sql:u.table[Se]||b===void 0?n(u.table[m.Symbol.Name])+"."+n(y):n(b)+"."+n(u.table[m.Symbol.Name])+"."+n(y),params:[]}}if(h(u,ae)){const y=u[x].schema,b=u[x].name;return{sql:y===void 0||u[x].isAlias?n(b):n(y)+"."+n(b),params:[]}}if(h(u,Z)){if(h(u.value,ne))return{sql:o(f.value++,u),params:[u],typings:["none"]};const y=u.value===null?null:u.encoder.mapToDriverValue(u.value);if(h(y,p))return this.buildQueryFromSourceParams([y],s);if(c)return{sql:this.mapInlineParam(y,s),params:[]};let b=["none"];return l&&(b=[l(u.encoder)]),{sql:o(f.value++,y),params:[y],typings:b}}return h(u,ne)?{sql:o(f.value++,u),params:[u],typings:["none"]}:h(u,p.Aliased)&&u.fieldAlias!==void 0?{sql:n(u.fieldAlias),params:[]}:h(u,D)?u._.isWith?{sql:n(u._.alias),params:[]}:this.buildQueryFromSourceParams([new q("("),u._.sql,new q(") "),new Fe(u._.alias)],s):Ct(u)?u.schema?{sql:n(u.schema)+"."+n(u.enumName),params:[]}:{sql:n(u.enumName),params:[]}:it(u)?u.shouldOmitSQLParens?.()?this.buildQueryFromSourceParams([u.getSQL()],s):this.buildQueryFromSourceParams([new q("("),u.getSQL(),new q(")")],s):c?{sql:this.mapInlineParam(u,s),params:[]}:{sql:o(f.value++,u),params:[u],typings:["none"]}}))}mapInlineParam(e,{escapeString:t}){if(e===null)return"null";if(typeof e=="number"||typeof e=="boolean")return e.toString();if(typeof e=="string")return t(e);if(typeof e=="object"){const s=e.toString();return t(s==="[object Object]"?JSON.stringify(e):s)}throw new Error("Unexpected param value: "+e)}getSQL(){return this}as(e){return e===void 0?this:new p.Aliased(this,e)}mapWith(e){return this.decoder=typeof e=="function"?{mapFromDriverValue:e}:e,this}inlineParams(){return this.shouldInlineParams=!0,this}if(e){return e?this:void 0}}class Fe{constructor(e){this.value=e}static[d]="Name";brand;getSQL(){return new p([this])}}function vt(i){return typeof i=="object"&&i!==null&&"mapToDriverValue"in i&&typeof i.mapToDriverValue=="function"}const rt={mapFromDriverValue:i=>i},nt={mapToDriverValue:i=>i};({...rt,...nt});class Z{constructor(e,t=nt){this.value=e,this.encoder=t}static[d]="Param";brand;getSQL(){return new p([this])}}function a(i,...e){const t=[];(e.length>0||i.length>0&&i[0]!=="")&&t.push(new q(i[0]));for(const[s,r]of e.entries())t.push(r,new q(i[s+1]));return new p(t)}(i=>{function e(){return new p([])}i.empty=e;function t(c){return new p(c)}i.fromList=t;function s(c){return new p([new q(c)])}i.raw=s;function r(c,f){const u=[];for(const[y,b]of c.entries())y>0&&f!==void 0&&u.push(f),u.push(b);return new p(u)}i.join=r;function n(c){return new Fe(c)}i.identifier=n;function o(c){return new ne(c)}i.placeholder=o;function l(c,f){return new Z(c,f)}i.param=l})(a||(a={}));(i=>{class e{constructor(s,r){this.sql=s,this.fieldAlias=r}static[d]="SQL.Aliased";isSelectionField=!1;getSQL(){return this.sql}clone(){return new e(this.sql,this.fieldAlias)}}i.Aliased=e})(p||(p={}));class ne{constructor(e){this.name=e}static[d]="Placeholder";getSQL(){return new p([this])}}function me(i,e){return i.map(t=>{if(h(t,ne)){if(!(t.name in e))throw new Error(`No value for placeholder "${t.name}" was provided`);return e[t.name]}if(h(t,Z)&&h(t.value,ne)){if(!(t.value.name in e))throw new Error(`No value for placeholder "${t.value.name}" was provided`);return t.encoder.mapToDriverValue(e[t.value.name])}return t})}const qt=Symbol.for("drizzle:IsDrizzleView");class ae{static[d]="View";[x];[qt]=!0;constructor({name:e,schema:t,selectedFields:s,query:r}){this[x]={name:e,originalName:e,schema:t,selectedFields:s,query:r,isExisting:!r,isAlias:!1}}getSQL(){return new p([this])}}B.prototype.getSQL=function(){return new p([this])};m.prototype.getSQL=function(){return new p([this])};D.prototype.getSQL=function(){return new p([this])};function We(i,e,t){const s={},r=i.reduce((n,{path:o,field:l},c)=>{let f;h(l,B)?f=l:h(l,p)?f=l.decoder:f=l.sql.decoder;let u=n;for(const[y,b]of o.entries())if(y<o.length-1)b in u||(u[b]={}),u=u[b];else{const N=e[c],$=u[b]=N===null?null:f.mapFromDriverValue(N);if(t&&h(l,B)&&o.length===2){const S=o[0];S in s?typeof s[S]=="string"&&s[S]!==re(l.table)&&(s[S]=!1):s[S]=$===null?re(l.table):!1}}return n},{});if(t&&Object.keys(s).length>0)for(const[n,o]of Object.entries(s))typeof o=="string"&&!t[o]&&(r[n]=null);return r}function ee(i,e){return Object.entries(i).reduce((t,[s,r])=>{if(typeof s!="string")return t;const n=e?[...e,s]:[s];return h(r,B)||h(r,p)||h(r,p.Aliased)?t.push({path:n,field:r}):h(r,m)?t.push(...ee(r[m.Symbol.Columns],n)):t.push(...ee(r,n)),t},[])}function je(i,e){const t=Object.keys(i),s=Object.keys(e);if(t.length!==s.length)return!1;for(const[r,n]of t.entries())if(n!==s[r])return!1;return!0}function at(i,e){const t=Object.entries(e).filter(([,s])=>s!==void 0).map(([s,r])=>h(r,p)||h(r,B)?[s,r]:[s,new Z(r,i[m.Symbol.Columns][s])]);if(t.length===0)throw new Error("No values to set");return Object.fromEntries(t)}function xt(i,e){for(const t of e)for(const s of Object.getOwnPropertyNames(t.prototype))s!=="constructor"&&Object.defineProperty(i.prototype,s,Object.getOwnPropertyDescriptor(t.prototype,s)||Object.create(null))}function Ot(i){return i[m.Symbol.Columns]}function Ie(i){return h(i,D)?i._.alias:h(i,ae)?i[x].name:h(i,p)?void 0:i[m.Symbol.IsAlias]?i[m.Symbol.Name]:i[m.Symbol.BaseName]}function ce(i,e){return{name:typeof i=="string"&&i.length>0?i:"",config:typeof i=="object"?i:e}}const ot=typeof TextDecoder>"u"?null:new TextDecoder,ke=Symbol.for("drizzle:PgInlineForeignKeys"),He=Symbol.for("drizzle:EnableRLS");class Ft extends m{static[d]="PgTable";static Symbol=Object.assign({},m.Symbol,{InlineForeignKeys:ke,EnableRLS:He});[ke]=[];[He]=!1;[m.Symbol.ExtraConfigBuilder]=void 0;[m.Symbol.ExtraConfigColumns]={}}class It{static[d]="PgPrimaryKeyBuilder";columns;name;constructor(e,t){this.columns=e,this.name=t}build(e){return new Rt(e,this.columns,this.name)}}class Rt{constructor(e,t,s){this.table=e,this.columns=t,this.name=s}static[d]="PgPrimaryKey";columns;name;getName(){return this.name??`${this.table[Ft.Symbol.Name]}_${this.columns.map(e=>e.name).join("_")}_pk`}}function R(i,e){return vt(e)&&!it(i)&&!h(i,Z)&&!h(i,ne)&&!h(i,B)&&!h(i,m)&&!h(i,ae)?new Z(i,e):i}const v=(i,e)=>a`${i} = ${R(e,i)}`,_t=(i,e)=>a`${i} <> ${R(e,i)}`;function H(...i){const e=i.filter(t=>t!==void 0);if(e.length!==0)return e.length===1?new p(e):new p([new q("("),a.join(e,new q(" and ")),new q(")")])}function At(...i){const e=i.filter(t=>t!==void 0);if(e.length!==0)return e.length===1?new p(e):new p([new q("("),a.join(e,new q(" or ")),new q(")")])}function jt(i){return a`not ${i}`}const Dt=(i,e)=>a`${i} > ${R(e,i)}`,be=(i,e)=>a`${i} >= ${R(e,i)}`,Pt=(i,e)=>a`${i} < ${R(e,i)}`,Et=(i,e)=>a`${i} <= ${R(e,i)}`;function lt(i,e){return Array.isArray(e)?e.length===0?a`false`:a`${i} in ${e.map(t=>R(t,i))}`:a`${i} in ${R(e,i)}`}function Mt(i,e){return Array.isArray(e)?e.length===0?a`true`:a`${i} not in ${e.map(t=>R(t,i))}`:a`${i} not in ${R(e,i)}`}function zt(i){return a`${i} is null`}function Kt(i){return a`${i} is not null`}function Vt(i){return a`exists ${i}`}function Ut(i){return a`not exists ${i}`}function Jt(i,e,t){return a`${i} between ${R(e,i)} and ${R(t,i)}`}function Wt(i,e,t){return a`${i} not between ${R(e,i)} and ${R(t,i)}`}function kt(i,e){return a`${i} like ${e}`}function Ht(i,e){return a`${i} not like ${e}`}function Yt(i,e){return a`${i} ilike ${e}`}function Gt(i,e){return a`${i} not ilike ${e}`}function Zt(i){return a`${i} asc`}function Xt(i){return a`${i} desc`}class ut{constructor(e,t,s){this.sourceTable=e,this.referencedTable=t,this.relationName=s,this.referencedTableName=t[m.Symbol.Name]}static[d]="Relation";referencedTableName;fieldName}class es{constructor(e,t){this.table=e,this.config=t}static[d]="Relations"}class te extends ut{constructor(e,t,s,r){super(e,t,s?.relationName),this.config=s,this.isNullable=r}static[d]="One";withFieldName(e){const t=new te(this.sourceTable,this.referencedTable,this.config,this.isNullable);return t.fieldName=e,t}}class Ce extends ut{constructor(e,t,s){super(e,t,s?.relationName),this.config=s}static[d]="Many";withFieldName(e){const t=new Ce(this.sourceTable,this.referencedTable,this.config);return t.fieldName=e,t}}function ts(){return{and:H,between:Jt,eq:v,exists:Vt,gt:Dt,gte:be,ilike:Yt,inArray:lt,isNull:zt,isNotNull:Kt,like:kt,lt:Pt,lte:Et,ne:_t,not:jt,notBetween:Wt,notExists:Ut,notLike:Ht,notIlike:Gt,notInArray:Mt,or:At,sql:a}}function ss(){return{sql:a,asc:Zt,desc:Xt}}function is(i,e){Object.keys(i).length===1&&"default"in i&&!h(i.default,m)&&(i=i.default);const t={},s={},r={};for(const[n,o]of Object.entries(i))if(h(o,m)){const l=le(o),c=s[l];t[l]=n,r[n]={tsName:n,dbName:o[m.Symbol.Name],schema:o[m.Symbol.Schema],columns:o[m.Symbol.Columns],relations:c?.relations??{},primaryKey:c?.primaryKey??[]};for(const u of Object.values(o[m.Symbol.Columns]))u.primary&&r[n].primaryKey.push(u);const f=o[m.Symbol.ExtraConfigBuilder]?.(o[m.Symbol.ExtraConfigColumns]);if(f)for(const u of Object.values(f))h(u,It)&&r[n].primaryKey.push(...u.columns)}else if(h(o,es)){const l=le(o.table),c=t[l],f=o.config(e(o.table));let u;for(const[y,b]of Object.entries(f))if(c){const N=r[c];N.relations[y]=b}else l in s||(s[l]={relations:{},primaryKey:u}),s[l].relations[y]=b}return{tables:r,tableNamesMap:t}}function rs(i){return function(t,s){return new te(i,t,s,s?.fields.reduce((r,n)=>r&&n.notNull,!0)??!1)}}function ns(i){return function(t,s){return new Ce(i,t,s)}}function as(i,e,t){if(h(t,te)&&t.config)return{fields:t.config.fields,references:t.config.references};const s=e[le(t.referencedTable)];if(!s)throw new Error(`Table "${t.referencedTable[m.Symbol.Name]}" not found in schema`);const r=i[s];if(!r)throw new Error(`Table "${s}" not found in schema`);const n=t.sourceTable,o=e[le(n)];if(!o)throw new Error(`Table "${n[m.Symbol.Name]}" not found in schema`);const l=[];for(const c of Object.values(r.relations))(t.relationName&&t!==c&&c.relationName===t.relationName||!t.relationName&&c.referencedTable===t.sourceTable)&&l.push(c);if(l.length>1)throw t.relationName?new Error(`There are multiple relations with name "${t.relationName}" in table "${s}"`):new Error(`There are multiple relations between "${s}" and "${t.sourceTable[m.Symbol.Name]}". Please specify relation name`);if(l[0]&&h(l[0],te)&&l[0].config)return{fields:l[0].config.references,references:l[0].config.fields};throw new Error(`There is not enough information to infer relation "${o}.${t.fieldName}"`)}function os(i){return{one:rs(i),many:ns(i)}}function Re(i,e,t,s,r=n=>n){const n={};for(const[o,l]of s.entries())if(l.isJson){const c=e.relations[l.tsKey],f=t[o],u=typeof f=="string"?JSON.parse(f):f;n[l.tsKey]=h(c,te)?u&&Re(i,i[l.relationTableTsKey],u,l.selection,r):u.map(y=>Re(i,i[l.relationTableTsKey],y,l.selection,r))}else{const c=r(t[o]),f=l.field;let u;h(f,B)?u=f:h(f,p)?u=f.decoder:u=f.sql.decoder,n[l.tsKey]=c===null?null:u.mapFromDriverValue(c)}return n}class Qe{constructor(e){this.table=e}static[d]="ColumnAliasProxyHandler";get(e,t){return t==="table"?this.table:e[t]}}class De{constructor(e,t){this.alias=e,this.replaceOriginalName=t}static[d]="TableAliasProxyHandler";get(e,t){if(t===m.Symbol.IsAlias)return!0;if(t===m.Symbol.Name)return this.alias;if(this.replaceOriginalName&&t===m.Symbol.OriginalName)return this.alias;if(t===x)return{...e[x],name:this.alias,isAlias:!0};if(t===m.Symbol.Columns){const r=e[m.Symbol.Columns];if(!r)return r;const n={};return Object.keys(r).map(o=>{n[o]=new Proxy(r[o],new Qe(new Proxy(e,this)))}),n}const s=e[t];return h(s,B)?new Proxy(s,new Qe(new Proxy(e,this))):s}}function xe(i,e){return new Proxy(i,new De(e,!1))}function J(i,e){return new Proxy(i,new Qe(new Proxy(i.table,new De(e,!1))))}function ct(i,e){return new p.Aliased(Le(i.sql,e),i.fieldAlias)}function Le(i,e){return a.join(i.queryChunks.map(t=>h(t,B)?J(t,e):h(t,p)?Le(t,e):h(t,p.Aliased)?ct(t,e):t))}class F{static[d]="SelectionProxyHandler";config;constructor(e){this.config={...e}}get(e,t){if(t==="_")return{...e._,selectedFields:new Proxy(e._.selectedFields,this)};if(t===x)return{...e[x],selectedFields:new Proxy(e[x].selectedFields,this)};if(typeof t=="symbol")return e[t];const r=(h(e,D)?e._.selectedFields:h(e,ae)?e[x].selectedFields:e)[t];if(h(r,p.Aliased)){if(this.config.sqlAliasedBehavior==="sql"&&!r.isSelectionField)return r.sql;const n=r.clone();return n.isSelectionField=!0,n}if(h(r,p)){if(this.config.sqlBehavior==="sql")return r;throw new Error(`You tried to reference "${t}" field from a subquery, which is a raw SQL field, but it doesn't have an alias declared. Please add an alias to the field using ".as('alias')" method.`)}return h(r,B)?this.config.alias?new Proxy(r,new Qe(new Proxy(r.table,new De(this.config.alias,this.config.replaceOriginalName??!1)))):r:typeof r!="object"||r===null?r:new Proxy(r,new F(this.config))}}class se{static[d]="QueryPromise";[Symbol.toStringTag]="QueryPromise";catch(e){return this.then(void 0,e)}finally(e){return this.then(t=>(e?.(),t),t=>{throw e?.(),t})}then(e,t){return this.execute().then(e,t)}}class ls{static[d]="SQLiteForeignKeyBuilder";reference;_onUpdate;_onDelete;constructor(e,t){this.reference=()=>{const{name:s,columns:r,foreignColumns:n}=e();return{name:s,columns:r,foreignTable:n[0].table,foreignColumns:n}},t&&(this._onUpdate=t.onUpdate,this._onDelete=t.onDelete)}onUpdate(e){return this._onUpdate=e,this}onDelete(e){return this._onDelete=e,this}build(e){return new us(e,this)}}class us{constructor(e,t){this.table=e,this.reference=t.reference,this.onUpdate=t._onUpdate,this.onDelete=t._onDelete}static[d]="SQLiteForeignKey";reference;onUpdate;onDelete;getName(){const{name:e,columns:t,foreignColumns:s}=this.reference(),r=t.map(l=>l.name),n=s.map(l=>l.name),o=[this.table[G],...r,s[0].table[G],...n];return e??`${o.join("_")}_fk`}}function cs(i,e){return`${i[G]}_${e.join("_")}_unique`}class M extends $t{static[d]="SQLiteColumnBuilder";foreignKeyConfigs=[];references(e,t={}){return this.foreignKeyConfigs.push({ref:e,actions:t}),this}unique(e){return this.config.isUnique=!0,this.config.uniqueName=e,this}generatedAlwaysAs(e,t){return this.config.generated={as:e,type:"always",mode:t?.mode??"virtual"},this}buildForeignKeys(e,t){return this.foreignKeyConfigs.map(({ref:s,actions:r})=>((n,o)=>{const l=new ls(()=>{const c=n();return{columns:[e],foreignColumns:[c]}});return o.onUpdate&&l.onUpdate(o.onUpdate),o.onDelete&&l.onDelete(o.onDelete),l.build(t)})(s,r))}}class I extends B{constructor(e,t){t.uniqueName||(t.uniqueName=cs(e,[t.name])),super(e,t),this.table=e}static[d]="SQLiteColumn"}class hs extends M{static[d]="SQLiteBigIntBuilder";constructor(e){super(e,"bigint","SQLiteBigInt")}build(e){return new ds(e,this.config)}}class ds extends I{static[d]="SQLiteBigInt";getSQLType(){return"blob"}mapFromDriverValue(e){if(typeof Buffer<"u"&&Buffer.from){const t=Buffer.isBuffer(e)?e:e instanceof ArrayBuffer?Buffer.from(e):e.buffer?Buffer.from(e.buffer,e.byteOffset,e.byteLength):Buffer.from(e);return BigInt(t.toString("utf8"))}return BigInt(ot.decode(e))}mapToDriverValue(e){return Buffer.from(e.toString())}}class fs extends M{static[d]="SQLiteBlobJsonBuilder";constructor(e){super(e,"json","SQLiteBlobJson")}build(e){return new ms(e,this.config)}}class ms extends I{static[d]="SQLiteBlobJson";getSQLType(){return"blob"}mapFromDriverValue(e){if(typeof Buffer<"u"&&Buffer.from){const t=Buffer.isBuffer(e)?e:e instanceof ArrayBuffer?Buffer.from(e):e.buffer?Buffer.from(e.buffer,e.byteOffset,e.byteLength):Buffer.from(e);return JSON.parse(t.toString("utf8"))}return JSON.parse(ot.decode(e))}mapToDriverValue(e){return Buffer.from(JSON.stringify(e))}}class ps extends M{static[d]="SQLiteBlobBufferBuilder";constructor(e){super(e,"buffer","SQLiteBlobBuffer")}build(e){return new ys(e,this.config)}}class ys extends I{static[d]="SQLiteBlobBuffer";mapFromDriverValue(e){return Buffer.isBuffer(e)?e:Buffer.from(e)}getSQLType(){return"blob"}}function gs(i,e){const{name:t,config:s}=ce(i,e);return s?.mode==="json"?new fs(t):s?.mode==="bigint"?new hs(t):new ps(t)}class bs extends M{static[d]="SQLiteCustomColumnBuilder";constructor(e,t,s){super(e,"custom","SQLiteCustomColumn"),this.config.fieldConfig=t,this.config.customTypeParams=s}build(e){return new ws(e,this.config)}}class ws extends I{static[d]="SQLiteCustomColumn";sqlName;mapTo;mapFrom;constructor(e,t){super(e,t),this.sqlName=t.customTypeParams.dataType(t.fieldConfig),this.mapTo=t.customTypeParams.toDriver,this.mapFrom=t.customTypeParams.fromDriver}getSQLType(){return this.sqlName}mapFromDriverValue(e){return typeof this.mapFrom=="function"?this.mapFrom(e):e}mapToDriverValue(e){return typeof this.mapTo=="function"?this.mapTo(e):e}}function Ss(i){return(e,t)=>{const{name:s,config:r}=ce(e,t);return new bs(s,r,i)}}class Pe extends M{static[d]="SQLiteBaseIntegerBuilder";constructor(e,t,s){super(e,t,s),this.config.autoIncrement=!1}primaryKey(e){return e?.autoIncrement&&(this.config.autoIncrement=!0),this.config.hasDefault=!0,super.primaryKey()}}class Ee extends I{static[d]="SQLiteBaseInteger";autoIncrement=this.config.autoIncrement;getSQLType(){return"integer"}}class Qs extends Pe{static[d]="SQLiteIntegerBuilder";constructor(e){super(e,"number","SQLiteInteger")}build(e){return new Ls(e,this.config)}}class Ls extends Ee{static[d]="SQLiteInteger"}class Ns extends Pe{static[d]="SQLiteTimestampBuilder";constructor(e,t){super(e,"date","SQLiteTimestamp"),this.config.mode=t}defaultNow(){return this.default(a`(cast((julianday('now') - 2440587.5)*86400000 as integer))`)}build(e){return new $s(e,this.config)}}class $s extends Ee{static[d]="SQLiteTimestamp";mode=this.config.mode;mapFromDriverValue(e){return this.config.mode==="timestamp"?new Date(e*1e3):new Date(e)}mapToDriverValue(e){const t=e.getTime();return this.config.mode==="timestamp"?Math.floor(t/1e3):t}}class Cs extends Pe{static[d]="SQLiteBooleanBuilder";constructor(e,t){super(e,"boolean","SQLiteBoolean"),this.config.mode=t}build(e){return new Ts(e,this.config)}}class Ts extends Ee{static[d]="SQLiteBoolean";mode=this.config.mode;mapFromDriverValue(e){return Number(e)===1}mapToDriverValue(e){return e?1:0}}function ue(i,e){const{name:t,config:s}=ce(i,e);return s?.mode==="timestamp"||s?.mode==="timestamp_ms"?new Ns(t,s.mode):s?.mode==="boolean"?new Cs(t,s.mode):new Qs(t)}class Bs extends M{static[d]="SQLiteNumericBuilder";constructor(e){super(e,"string","SQLiteNumeric")}build(e){return new vs(e,this.config)}}class vs extends I{static[d]="SQLiteNumeric";mapFromDriverValue(e){return typeof e=="string"?e:String(e)}getSQLType(){return"numeric"}}class qs extends M{static[d]="SQLiteNumericNumberBuilder";constructor(e){super(e,"number","SQLiteNumericNumber")}build(e){return new xs(e,this.config)}}class xs extends I{static[d]="SQLiteNumericNumber";mapFromDriverValue(e){return typeof e=="number"?e:Number(e)}mapToDriverValue=String;getSQLType(){return"numeric"}}class Os extends M{static[d]="SQLiteNumericBigIntBuilder";constructor(e){super(e,"bigint","SQLiteNumericBigInt")}build(e){return new Fs(e,this.config)}}class Fs extends I{static[d]="SQLiteNumericBigInt";mapFromDriverValue=BigInt;mapToDriverValue=String;getSQLType(){return"numeric"}}function Is(i,e){const{name:t,config:s}=ce(i,e),r=s?.mode;return r==="number"?new qs(t):r==="bigint"?new Os(t):new Bs(t)}class Rs extends M{static[d]="SQLiteRealBuilder";constructor(e){super(e,"number","SQLiteReal")}build(e){return new _s(e,this.config)}}class _s extends I{static[d]="SQLiteReal";getSQLType(){return"real"}}function As(i){return new Rs(i??"")}class js extends M{static[d]="SQLiteTextBuilder";constructor(e,t){super(e,"string","SQLiteText"),this.config.enumValues=t.enum,this.config.length=t.length}build(e){return new Ds(e,this.config)}}class Ds extends I{static[d]="SQLiteText";enumValues=this.config.enumValues;length=this.config.length;constructor(e,t){super(e,t)}getSQLType(){return`text${this.config.length?`(${this.config.length})`:""}`}}class Ps extends M{static[d]="SQLiteTextJsonBuilder";constructor(e){super(e,"json","SQLiteTextJson")}build(e){return new Es(e,this.config)}}class Es extends I{static[d]="SQLiteTextJson";getSQLType(){return"text"}mapFromDriverValue(e){return JSON.parse(e)}mapToDriverValue(e){return JSON.stringify(e)}}function W(i,e={}){const{name:t,config:s}=ce(i,e);return s.mode==="json"?new Ps(t):new js(t,s)}function Ms(){return{blob:gs,customType:Ss,integer:ue,numeric:Is,real:As,text:W}}const _e=Symbol.for("drizzle:SQLiteInlineForeignKeys");class E extends m{static[d]="SQLiteTable";static Symbol=Object.assign({},m.Symbol,{InlineForeignKeys:_e});[m.Symbol.Columns];[_e]=[];[m.Symbol.ExtraConfigBuilder]=void 0}function zs(i,e,t,s,r=i){const n=new E(i,s,r),o=typeof e=="function"?e(Ms()):e,l=Object.fromEntries(Object.entries(o).map(([f,u])=>{const y=u;y.setName(f);const b=y.build(n);return n[_e].push(...y.buildForeignKeys(b,n)),[f,b]})),c=Object.assign(n,l);return c[m.Symbol.Columns]=l,c[m.Symbol.ExtraConfigColumns]=l,c}const ht=(i,e,t)=>zs(i,e);function X(i){return h(i,E)?[`${i[m.Symbol.BaseName]}`]:h(i,D)?i._.usedTables??[]:h(i,p)?i.usedTables??[]:[]}class Ye extends se{constructor(e,t,s,r){super(),this.table=e,this.session=t,this.dialect=s,this.config={table:e,withList:r}}static[d]="SQLiteDelete";config;where(e){return this.config.where=e,this}orderBy(...e){if(typeof e[0]=="function"){const t=e[0](new Proxy(this.config.table[m.Symbol.Columns],new F({sqlAliasedBehavior:"alias",sqlBehavior:"sql"}))),s=Array.isArray(t)?t:[t];this.config.orderBy=s}else{const t=e;this.config.orderBy=t}return this}limit(e){return this.config.limit=e,this}returning(e=this.table[E.Symbol.Columns]){return this.config.returning=ee(e),this}getSQL(){return this.dialect.buildDeleteQuery(this.config)}toSQL(){const{typings:e,...t}=this.dialect.sqlToQuery(this.getSQL());return t}_prepare(e=!0){return this.session[e?"prepareOneTimeQuery":"prepareQuery"](this.dialect.sqlToQuery(this.getSQL()),this.config.returning,this.config.returning?"all":"run",!0,void 0,{type:"delete",tables:X(this.config.table)})}prepare(){return this._prepare(!1)}run=e=>this._prepare().run(e);all=e=>this._prepare().all(e);get=e=>this._prepare().get(e);values=e=>this._prepare().values(e);async execute(e){return this._prepare().execute(e)}$dynamic(){return this}}function Ks(i){return(i.replace(/['\u2019]/g,"").match(/[\da-z]+|[A-Z]+(?![a-z])|[A-Z][\da-z]+/g)??[]).map(t=>t.toLowerCase()).join("_")}function Vs(i){return(i.replace(/['\u2019]/g,"").match(/[\da-z]+|[A-Z]+(?![a-z])|[A-Z][\da-z]+/g)??[]).reduce((t,s,r)=>{const n=r===0?s.toLowerCase():`${s[0].toUpperCase()}${s.slice(1)}`;return t+n},"")}function Us(i){return i}class Js{static[d]="CasingCache";cache={};cachedTables={};convert;constructor(e){this.convert=e==="snake_case"?Ks:e==="camelCase"?Vs:Us}getColumnCasing(e){if(!e.keyAsName)return e.name;const t=e.table[m.Symbol.Schema]??"public",s=e.table[m.Symbol.OriginalName],r=`${t}.${s}.${e.name}`;return this.cache[r]||this.cacheTable(e.table),this.cache[r]}cacheTable(e){const t=e[m.Symbol.Schema]??"public",s=e[m.Symbol.OriginalName],r=`${t}.${s}`;if(!this.cachedTables[r]){for(const n of Object.values(e[m.Symbol.Columns])){const o=`${r}.${n.name}`;this.cache[o]=this.convert(n.name)}this.cachedTables[r]=!0}}clearCache(){this.cache={},this.cachedTables={}}}class Me extends Error{static[d]="DrizzleError";constructor({message:e,cause:t}){super(e),this.name="DrizzleError",this.cause=t}}class k extends Error{constructor(e,t,s){super(`Failed query: ${e}
params: ${t}`),this.query=e,this.params=t,this.cause=s,Error.captureStackTrace(this,k),s&&(this.cause=s)}}class Ws extends Me{static[d]="TransactionRollbackError";constructor(){super({message:"Rollback"})}}class ze extends ae{static[d]="SQLiteViewBase"}class Ne{static[d]="SQLiteDialect";casing;constructor(e){this.casing=new Js(e?.casing)}escapeName(e){return`"${e}"`}escapeParam(e){return"?"}escapeString(e){return`'${e.replace(/'/g,"''")}'`}buildWithCTE(e){if(!e?.length)return;const t=[a`with `];for(const[s,r]of e.entries())t.push(a`${a.identifier(r._.alias)} as (${r._.sql})`),s<e.length-1&&t.push(a`, `);return t.push(a` `),a.join(t)}buildDeleteQuery({table:e,where:t,returning:s,withList:r,limit:n,orderBy:o}){const l=this.buildWithCTE(r),c=s?a` returning ${this.buildSelection(s,{isSingleTable:!0})}`:void 0,f=t?a` where ${t}`:void 0,u=this.buildOrderBy(o),y=this.buildLimit(n);return a`${l}delete from ${e}${f}${c}${u}${y}`}buildUpdateSet(e,t){const s=e[m.Symbol.Columns],r=Object.keys(s).filter(o=>t[o]!==void 0||s[o]?.onUpdateFn!==void 0),n=r.length;return a.join(r.flatMap((o,l)=>{const c=s[o],f=t[o]??a.param(c.onUpdateFn(),c),u=a`${a.identifier(this.casing.getColumnCasing(c))} = ${f}`;return l<n-1?[u,a.raw(", ")]:[u]}))}buildUpdateQuery({table:e,set:t,where:s,returning:r,withList:n,joins:o,from:l,limit:c,orderBy:f}){const u=this.buildWithCTE(n),y=this.buildUpdateSet(e,t),b=l&&a.join([a.raw(" from "),this.buildFromTable(l)]),N=this.buildJoins(o),$=r?a` returning ${this.buildSelection(r,{isSingleTable:!0})}`:void 0,S=s?a` where ${s}`:void 0,C=this.buildOrderBy(f),T=this.buildLimit(c);return a`${u}update ${e} set ${y}${b}${N}${S}${$}${C}${T}`}buildSelection(e,{isSingleTable:t=!1}={}){const s=e.length,r=e.flatMap(({field:n},o)=>{const l=[];if(h(n,p.Aliased)&&n.isSelectionField)l.push(a.identifier(n.fieldAlias));else if(h(n,p.Aliased)||h(n,p)){const c=h(n,p.Aliased)?n.sql:n;t?l.push(new p(c.queryChunks.map(f=>h(f,B)?a.identifier(this.casing.getColumnCasing(f)):f))):l.push(c),h(n,p.Aliased)&&l.push(a` as ${a.identifier(n.fieldAlias)}`)}else if(h(n,B)){const c=n.table[m.Symbol.Name];n.columnType==="SQLiteNumericBigInt"?t?l.push(a`cast(${a.identifier(this.casing.getColumnCasing(n))} as text)`):l.push(a`cast(${a.identifier(c)}.${a.identifier(this.casing.getColumnCasing(n))} as text)`):t?l.push(a.identifier(this.casing.getColumnCasing(n))):l.push(a`${a.identifier(c)}.${a.identifier(this.casing.getColumnCasing(n))}`)}return o<s-1&&l.push(a`, `),l});return a.join(r)}buildJoins(e){if(!e||e.length===0)return;const t=[];if(e)for(const[s,r]of e.entries()){s===0&&t.push(a` `);const n=r.table,o=r.on?a` on ${r.on}`:void 0;if(h(n,E)){const l=n[E.Symbol.Name],c=n[E.Symbol.Schema],f=n[E.Symbol.OriginalName],u=l===f?void 0:r.alias;t.push(a`${a.raw(r.joinType)} join ${c?a`${a.identifier(c)}.`:void 0}${a.identifier(f)}${u&&a` ${a.identifier(u)}`}${o}`)}else t.push(a`${a.raw(r.joinType)} join ${n}${o}`);s<e.length-1&&t.push(a` `)}return a.join(t)}buildLimit(e){return typeof e=="object"||typeof e=="number"&&e>=0?a` limit ${e}`:void 0}buildOrderBy(e){const t=[];if(e)for(const[s,r]of e.entries())t.push(r),s<e.length-1&&t.push(a`, `);return t.length>0?a` order by ${a.join(t)}`:void 0}buildFromTable(e){return h(e,m)&&e[m.Symbol.IsAlias]?a`${a`${a.identifier(e[m.Symbol.Schema]??"")}.`.if(e[m.Symbol.Schema])}${a.identifier(e[m.Symbol.OriginalName])} ${a.identifier(e[m.Symbol.Name])}`:e}buildSelectQuery({withList:e,fields:t,fieldsFlat:s,where:r,having:n,table:o,joins:l,orderBy:c,groupBy:f,limit:u,offset:y,distinct:b,setOperators:N}){const $=s??ee(t);for(const P of $)if(h(P.field,B)&&re(P.field.table)!==(h(o,D)?o._.alias:h(o,ze)?o[x].name:h(o,p)?void 0:re(o))&&!(z=>l?.some(({alias:de})=>de===(z[m.Symbol.IsAlias]?re(z):z[m.Symbol.BaseName])))(P.field.table)){const z=re(P.field.table);throw new Error(`Your "${P.path.join("->")}" field references a column "${z}"."${P.field.name}", but the table "${z}" is not part of the query! Did you forget to join it?`)}const S=!l||l.length===0,C=this.buildWithCTE(e),T=b?a` distinct`:void 0,_=this.buildSelection($,{isSingleTable:S}),O=this.buildFromTable(o),Q=this.buildJoins(l),V=r?a` where ${r}`:void 0,A=n?a` having ${n}`:void 0,g=[];if(f)for(const[P,z]of f.entries())g.push(z),P<f.length-1&&g.push(a`, `);const L=g.length>0?a` group by ${a.join(g)}`:void 0,U=this.buildOrderBy(c),he=this.buildLimit(u),Be=y?a` offset ${y}`:void 0,ie=a`${C}select${T} ${_} from ${O}${Q}${V}${L}${A}${U}${he}${Be}`;return N.length>0?this.buildSetOperations(ie,N):ie}buildSetOperations(e,t){const[s,...r]=t;if(!s)throw new Error("Cannot pass undefined values to any set operator");return r.length===0?this.buildSetOperationQuery({leftSelect:e,setOperator:s}):this.buildSetOperations(this.buildSetOperationQuery({leftSelect:e,setOperator:s}),r)}buildSetOperationQuery({leftSelect:e,setOperator:{type:t,isAll:s,rightSelect:r,limit:n,orderBy:o,offset:l}}){const c=a`${e.getSQL()} `,f=a`${r.getSQL()}`;let u;if(o&&o.length>0){const $=[];for(const S of o)if(h(S,I))$.push(a.identifier(S.name));else if(h(S,p)){for(let C=0;C<S.queryChunks.length;C++){const T=S.queryChunks[C];h(T,I)&&(S.queryChunks[C]=a.identifier(this.casing.getColumnCasing(T)))}$.push(a`${S}`)}else $.push(a`${S}`);u=a` order by ${a.join($,a`, `)}`}const y=typeof n=="object"||typeof n=="number"&&n>=0?a` limit ${n}`:void 0,b=a.raw(`${t} ${s?"all ":""}`),N=l?a` offset ${l}`:void 0;return a`${c}${b}${f}${u}${y}${N}`}buildInsertQuery({table:e,values:t,onConflict:s,returning:r,withList:n,select:o}){const l=[],c=e[m.Symbol.Columns],f=Object.entries(c).filter(([S,C])=>!C.shouldDisableInsert()),u=f.map(([,S])=>a.identifier(this.casing.getColumnCasing(S)));if(o){const S=t;h(S,p)?l.push(S):l.push(S.getSQL())}else{const S=t;l.push(a.raw("values "));for(const[C,T]of S.entries()){const _=[];for(const[O,Q]of f){const V=T[O];if(V===void 0||h(V,Z)&&V.value===void 0){let A;if(Q.default!==null&&Q.default!==void 0)A=h(Q.default,p)?Q.default:a.param(Q.default,Q);else if(Q.defaultFn!==void 0){const g=Q.defaultFn();A=h(g,p)?g:a.param(g,Q)}else if(!Q.default&&Q.onUpdateFn!==void 0){const g=Q.onUpdateFn();A=h(g,p)?g:a.param(g,Q)}else A=a`null`;_.push(A)}else _.push(V)}l.push(_),C<S.length-1&&l.push(a`, `)}}const y=this.buildWithCTE(n),b=a.join(l),N=r?a` returning ${this.buildSelection(r,{isSingleTable:!0})}`:void 0,$=s?.length?a.join(s):void 0;return a`${y}insert into ${e} ${u} ${b}${$}${N}`}sqlToQuery(e,t){return e.toQuery({casing:this.casing,escapeName:this.escapeName,escapeParam:this.escapeParam,escapeString:this.escapeString,invokeSource:t})}buildRelationalQuery({fullSchema:e,schema:t,tableNamesMap:s,table:r,tableConfig:n,queryConfig:o,tableAlias:l,nestedQueryRelation:c,joinOn:f}){let u=[],y,b,N=[],$;const S=[];if(o===!0)u=Object.entries(n.columns).map(([_,O])=>({dbKey:O.name,tsKey:_,field:J(O,l),relationTableTsKey:void 0,isJson:!1,selection:[]}));else{const T=Object.fromEntries(Object.entries(n.columns).map(([g,L])=>[g,J(L,l)]));if(o.where){const g=typeof o.where=="function"?o.where(T,ts()):o.where;$=g&&Le(g,l)}const _=[];let O=[];if(o.columns){let g=!1;for(const[L,U]of Object.entries(o.columns))U!==void 0&&L in n.columns&&(!g&&U===!0&&(g=!0),O.push(L));O.length>0&&(O=g?O.filter(L=>o.columns?.[L]===!0):Object.keys(n.columns).filter(L=>!O.includes(L)))}else O=Object.keys(n.columns);for(const g of O){const L=n.columns[g];_.push({tsKey:g,value:L})}let Q=[];o.with&&(Q=Object.entries(o.with).filter(g=>!!g[1]).map(([g,L])=>({tsKey:g,queryConfig:L,relation:n.relations[g]})));let V;if(o.extras){V=typeof o.extras=="function"?o.extras(T,{sql:a}):o.extras;for(const[g,L]of Object.entries(V))_.push({tsKey:g,value:ct(L,l)})}for(const{tsKey:g,value:L}of _)u.push({dbKey:h(L,p.Aliased)?L.fieldAlias:n.columns[g].name,tsKey:g,field:h(L,B)?J(L,l):L,relationTableTsKey:void 0,isJson:!1,selection:[]});let A=typeof o.orderBy=="function"?o.orderBy(T,ss()):o.orderBy??[];Array.isArray(A)||(A=[A]),N=A.map(g=>h(g,B)?J(g,l):Le(g,l)),y=o.limit,b=o.offset;for(const{tsKey:g,queryConfig:L,relation:U}of Q){const he=as(t,s,U),Be=le(U.referencedTable),ie=s[Be],P=`${l}_${g}`,z=H(...he.fields.map((gt,bt)=>v(J(he.references[bt],P),J(gt,l)))),de=this.buildRelationalQuery({fullSchema:e,schema:t,tableNamesMap:s,table:e[ie],tableConfig:t[ie],queryConfig:h(U,te)?L===!0?{limit:1}:{...L,limit:1}:L,tableAlias:P,joinOn:z,nestedQueryRelation:U}),yt=a`(${de.sql})`.as(g);u.push({dbKey:g,tsKey:g,field:yt,relationTableTsKey:ie,isJson:!0,selection:de.selection})}}if(u.length===0)throw new Me({message:`No fields selected for table "${n.tsName}" ("${l}"). You need to have at least one item in "columns", "with" or "extras". If you need to select all columns, omit the "columns" key or set it to undefined.`});let C;if($=H(f,$),c){let T=a`json_array(${a.join(u.map(({field:Q})=>h(Q,I)?a.identifier(this.casing.getColumnCasing(Q)):h(Q,p.Aliased)?Q.sql:Q),a`, `)})`;h(c,Ce)&&(T=a`coalesce(json_group_array(${T}), json_array())`);const _=[{dbKey:"data",tsKey:"data",field:T.as("data"),isJson:!0,relationTableTsKey:n.tsName,selection:u}];y!==void 0||b!==void 0||N.length>0?(C=this.buildSelectQuery({table:xe(r,l),fields:{},fieldsFlat:[{path:[],field:a.raw("*")}],where:$,limit:y,offset:b,orderBy:N,setOperators:[]}),$=void 0,y=void 0,b=void 0,N=void 0):C=xe(r,l),C=this.buildSelectQuery({table:h(C,E)?C:new D(C,{},l),fields:{},fieldsFlat:_.map(({field:Q})=>({path:[],field:h(Q,B)?J(Q,l):Q})),joins:S,where:$,limit:y,offset:b,orderBy:N,setOperators:[]})}else C=this.buildSelectQuery({table:xe(r,l),fields:{},fieldsFlat:u.map(({field:T})=>({path:[],field:h(T,B)?J(T,l):T})),joins:S,where:$,limit:y,offset:b,orderBy:N,setOperators:[]});return{tableTsKey:n.tsName,sql:C,selection:u}}}class ks extends Ne{static[d]="SQLiteSyncDialect";migrate(e,t,s){const r=s===void 0||typeof s=="string"?"__drizzle_migrations":s.migrationsTable??"__drizzle_migrations",n=a`
			CREATE TABLE IF NOT EXISTS ${a.identifier(r)} (
				id SERIAL PRIMARY KEY,
				hash text NOT NULL,
				created_at numeric
			)
		`;t.run(n);const l=t.values(a`SELECT id, hash, created_at FROM ${a.identifier(r)} ORDER BY created_at DESC LIMIT 1`)[0]??void 0;t.run(a`BEGIN`);try{for(const c of e)if(!l||Number(l[2])<c.folderMillis){for(const f of c.sql)t.run(a.raw(f));t.run(a`INSERT INTO ${a.identifier(r)} ("hash", "created_at") VALUES(${c.hash}, ${c.folderMillis})`)}t.run(a`COMMIT`)}catch(c){throw t.run(a`ROLLBACK`),c}}}class Hs extends Ne{static[d]="SQLiteAsyncDialect";async migrate(e,t,s){const r=s===void 0||typeof s=="string"?"__drizzle_migrations":s.migrationsTable??"__drizzle_migrations",n=a`
			CREATE TABLE IF NOT EXISTS ${a.identifier(r)} (
				id SERIAL PRIMARY KEY,
				hash text NOT NULL,
				created_at numeric
			)
		`;await t.run(n);const l=(await t.values(a`SELECT id, hash, created_at FROM ${a.identifier(r)} ORDER BY created_at DESC LIMIT 1`))[0]??void 0;await t.transaction(async c=>{for(const f of e)if(!l||Number(l[2])<f.folderMillis){for(const u of f.sql)await c.run(a.raw(u));await c.run(a`INSERT INTO ${a.identifier(r)} ("hash", "created_at") VALUES(${f.hash}, ${f.folderMillis})`)}})}}class Ys{static[d]="TypedQueryBuilder";getSelectedFields(){return this._.selectedFields}}class Y{static[d]="SQLiteSelectBuilder";fields;session;dialect;withList;distinct;constructor(e){this.fields=e.fields,this.session=e.session,this.dialect=e.dialect,this.withList=e.withList,this.distinct=e.distinct}from(e){const t=!!this.fields;let s;return this.fields?s=this.fields:h(e,D)?s=Object.fromEntries(Object.keys(e._.selectedFields).map(r=>[r,e[r]])):h(e,ze)?s=e[x].selectedFields:h(e,p)?s={}:s=Ot(e),new dt({table:e,fields:s,isPartialSelect:t,session:this.session,dialect:this.dialect,withList:this.withList,distinct:this.distinct})}}class Gs extends Ys{static[d]="SQLiteSelectQueryBuilder";_;config;joinsNotNullableMap;tableName;isPartialSelect;session;dialect;cacheConfig=void 0;usedTables=new Set;constructor({table:e,fields:t,isPartialSelect:s,session:r,dialect:n,withList:o,distinct:l}){super(),this.config={withList:o,table:e,fields:{...t},distinct:l,setOperators:[]},this.isPartialSelect=s,this.session=r,this.dialect=n,this._={selectedFields:t,config:this.config},this.tableName=Ie(e),this.joinsNotNullableMap=typeof this.tableName=="string"?{[this.tableName]:!0}:{};for(const c of X(e))this.usedTables.add(c)}getUsedTables(){return[...this.usedTables]}createJoin(e){return(t,s)=>{const r=this.tableName,n=Ie(t);for(const o of X(t))this.usedTables.add(o);if(typeof n=="string"&&this.config.joins?.some(o=>o.alias===n))throw new Error(`Alias "${n}" is already used in this query`);if(!this.isPartialSelect&&(Object.keys(this.joinsNotNullableMap).length===1&&typeof r=="string"&&(this.config.fields={[r]:this.config.fields}),typeof n=="string"&&!h(t,p))){const o=h(t,D)?t._.selectedFields:h(t,ae)?t[x].selectedFields:t[m.Symbol.Columns];this.config.fields[n]=o}if(typeof s=="function"&&(s=s(new Proxy(this.config.fields,new F({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})))),this.config.joins||(this.config.joins=[]),this.config.joins.push({on:s,table:t,joinType:e,alias:n}),typeof n=="string")switch(e){case"left":{this.joinsNotNullableMap[n]=!1;break}case"right":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([o])=>[o,!1])),this.joinsNotNullableMap[n]=!0;break}case"cross":case"inner":{this.joinsNotNullableMap[n]=!0;break}case"full":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([o])=>[o,!1])),this.joinsNotNullableMap[n]=!1;break}}return this}}leftJoin=this.createJoin("left");rightJoin=this.createJoin("right");innerJoin=this.createJoin("inner");fullJoin=this.createJoin("full");crossJoin=this.createJoin("cross");createSetOperator(e,t){return s=>{const r=typeof s=="function"?s(Zs()):s;if(!je(this.getSelectedFields(),r.getSelectedFields()))throw new Error("Set operator error (union / intersect / except): selected fields are not the same or are in a different order");return this.config.setOperators.push({type:e,isAll:t,rightSelect:r}),this}}union=this.createSetOperator("union",!1);unionAll=this.createSetOperator("union",!0);intersect=this.createSetOperator("intersect",!1);except=this.createSetOperator("except",!1);addSetOperators(e){return this.config.setOperators.push(...e),this}where(e){return typeof e=="function"&&(e=e(new Proxy(this.config.fields,new F({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})))),this.config.where=e,this}having(e){return typeof e=="function"&&(e=e(new Proxy(this.config.fields,new F({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})))),this.config.having=e,this}groupBy(...e){if(typeof e[0]=="function"){const t=e[0](new Proxy(this.config.fields,new F({sqlAliasedBehavior:"alias",sqlBehavior:"sql"})));this.config.groupBy=Array.isArray(t)?t:[t]}else this.config.groupBy=e;return this}orderBy(...e){if(typeof e[0]=="function"){const t=e[0](new Proxy(this.config.fields,new F({sqlAliasedBehavior:"alias",sqlBehavior:"sql"}))),s=Array.isArray(t)?t:[t];this.config.setOperators.length>0?this.config.setOperators.at(-1).orderBy=s:this.config.orderBy=s}else{const t=e;this.config.setOperators.length>0?this.config.setOperators.at(-1).orderBy=t:this.config.orderBy=t}return this}limit(e){return this.config.setOperators.length>0?this.config.setOperators.at(-1).limit=e:this.config.limit=e,this}offset(e){return this.config.setOperators.length>0?this.config.setOperators.at(-1).offset=e:this.config.offset=e,this}getSQL(){return this.dialect.buildSelectQuery(this.config)}toSQL(){const{typings:e,...t}=this.dialect.sqlToQuery(this.getSQL());return t}as(e){const t=[];if(t.push(...X(this.config.table)),this.config.joins)for(const s of this.config.joins)t.push(...X(s.table));return new Proxy(new D(this.getSQL(),this.config.fields,e,!1,[...new Set(t)]),new F({alias:e,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}getSelectedFields(){return new Proxy(this.config.fields,new F({alias:this.tableName,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}$dynamic(){return this}}class dt extends Gs{static[d]="SQLiteSelect";_prepare(e=!0){if(!this.session)throw new Error("Cannot execute a query on a query builder. Please use a database instance instead.");const t=ee(this.config.fields),s=this.session[e?"prepareOneTimeQuery":"prepareQuery"](this.dialect.sqlToQuery(this.getSQL()),t,"all",!0,void 0,{type:"select",tables:[...this.usedTables]},this.cacheConfig);return s.joinsNotNullableMap=this.joinsNotNullableMap,s}$withCache(e){return this.cacheConfig=e===void 0?{config:{},enable:!0,autoInvalidate:!0}:e===!1?{enable:!1}:{enable:!0,autoInvalidate:!0,...e},this}prepare(){return this._prepare(!1)}run=e=>this._prepare().run(e);all=e=>this._prepare().all(e);get=e=>this._prepare().get(e);values=e=>this._prepare().values(e);async execute(){return this.all()}}xt(dt,[se]);function Te(i,e){return(t,s,...r)=>{const n=[s,...r].map(o=>({type:i,isAll:e,rightSelect:o}));for(const o of n)if(!je(t.getSelectedFields(),o.rightSelect.getSelectedFields()))throw new Error("Set operator error (union / intersect / except): selected fields are not the same or are in a different order");return t.addSetOperators(n)}}const Zs=()=>({union:Xs,unionAll:ei,intersect:ti,except:si}),Xs=Te("union",!1),ei=Te("union",!0),ti=Te("intersect",!1),si=Te("except",!1);class ft{static[d]="SQLiteQueryBuilder";dialect;dialectConfig;constructor(e){this.dialect=h(e,Ne)?e:void 0,this.dialectConfig=h(e,Ne)?void 0:e}$with=(e,t)=>{const s=this;return{as:n=>(typeof n=="function"&&(n=n(s)),new Proxy(new st(n.getSQL(),t??("getSelectedFields"in n?n.getSelectedFields()??{}:{}),e,!0),new F({alias:e,sqlAliasedBehavior:"alias",sqlBehavior:"error"})))}};with(...e){const t=this;function s(n){return new Y({fields:n??void 0,session:void 0,dialect:t.getDialect(),withList:e})}function r(n){return new Y({fields:n??void 0,session:void 0,dialect:t.getDialect(),withList:e,distinct:!0})}return{select:s,selectDistinct:r}}select(e){return new Y({fields:e??void 0,session:void 0,dialect:this.getDialect()})}selectDistinct(e){return new Y({fields:e??void 0,session:void 0,dialect:this.getDialect(),distinct:!0})}getDialect(){return this.dialect||(this.dialect=new ks(this.dialectConfig)),this.dialect}}class Ge{constructor(e,t,s,r){this.table=e,this.session=t,this.dialect=s,this.withList=r}static[d]="SQLiteInsertBuilder";values(e){if(e=Array.isArray(e)?e:[e],e.length===0)throw new Error("values() must be called with at least one value");const t=e.map(s=>{const r={},n=this.table[m.Symbol.Columns];for(const o of Object.keys(s)){const l=s[o];r[o]=h(l,p)?l:new Z(l,n[o])}return r});return new Ze(this.table,t,this.session,this.dialect,this.withList)}select(e){const t=typeof e=="function"?e(new ft):e;if(!h(t,p)&&!je(this.table[Oe],t._.selectedFields))throw new Error("Insert select error: selected fields are not the same or are in a different order compared to the table definition");return new Ze(this.table,t,this.session,this.dialect,this.withList,!0)}}class Ze extends se{constructor(e,t,s,r,n,o){super(),this.session=s,this.dialect=r,this.config={table:e,values:t,withList:n,select:o}}static[d]="SQLiteInsert";config;returning(e=this.config.table[E.Symbol.Columns]){return this.config.returning=ee(e),this}onConflictDoNothing(e={}){if(this.config.onConflict||(this.config.onConflict=[]),e.target===void 0)this.config.onConflict.push(a` on conflict do nothing`);else{const t=Array.isArray(e.target)?a`${e.target}`:a`${[e.target]}`,s=e.where?a` where ${e.where}`:a``;this.config.onConflict.push(a` on conflict ${t} do nothing${s}`)}return this}onConflictDoUpdate(e){if(e.where&&(e.targetWhere||e.setWhere))throw new Error('You cannot use both "where" and "targetWhere"/"setWhere" at the same time - "where" is deprecated, use "targetWhere" or "setWhere" instead.');this.config.onConflict||(this.config.onConflict=[]);const t=e.where?a` where ${e.where}`:void 0,s=e.targetWhere?a` where ${e.targetWhere}`:void 0,r=e.setWhere?a` where ${e.setWhere}`:void 0,n=Array.isArray(e.target)?a`${e.target}`:a`${[e.target]}`,o=this.dialect.buildUpdateSet(this.config.table,at(this.config.table,e.set));return this.config.onConflict.push(a` on conflict ${n}${s} do update set ${o}${t}${r}`),this}getSQL(){return this.dialect.buildInsertQuery(this.config)}toSQL(){const{typings:e,...t}=this.dialect.sqlToQuery(this.getSQL());return t}_prepare(e=!0){return this.session[e?"prepareOneTimeQuery":"prepareQuery"](this.dialect.sqlToQuery(this.getSQL()),this.config.returning,this.config.returning?"all":"run",!0,void 0,{type:"insert",tables:X(this.config.table)})}prepare(){return this._prepare(!1)}run=e=>this._prepare().run(e);all=e=>this._prepare().all(e);get=e=>this._prepare().get(e);values=e=>this._prepare().values(e);async execute(){return this.config.returning?this.all():this.run()}$dynamic(){return this}}class Xe{constructor(e,t,s,r){this.table=e,this.session=t,this.dialect=s,this.withList=r}static[d]="SQLiteUpdateBuilder";set(e){return new ii(this.table,at(this.table,e),this.session,this.dialect,this.withList)}}class ii extends se{constructor(e,t,s,r,n){super(),this.session=s,this.dialect=r,this.config={set:t,table:e,withList:n,joins:[]}}static[d]="SQLiteUpdate";config;from(e){return this.config.from=e,this}createJoin(e){return(t,s)=>{const r=Ie(t);if(typeof r=="string"&&this.config.joins.some(n=>n.alias===r))throw new Error(`Alias "${r}" is already used in this query`);if(typeof s=="function"){const n=this.config.from?h(t,E)?t[m.Symbol.Columns]:h(t,D)?t._.selectedFields:h(t,ze)?t[x].selectedFields:void 0:void 0;s=s(new Proxy(this.config.table[m.Symbol.Columns],new F({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})),n&&new Proxy(n,new F({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})))}return this.config.joins.push({on:s,table:t,joinType:e,alias:r}),this}}leftJoin=this.createJoin("left");rightJoin=this.createJoin("right");innerJoin=this.createJoin("inner");fullJoin=this.createJoin("full");where(e){return this.config.where=e,this}orderBy(...e){if(typeof e[0]=="function"){const t=e[0](new Proxy(this.config.table[m.Symbol.Columns],new F({sqlAliasedBehavior:"alias",sqlBehavior:"sql"}))),s=Array.isArray(t)?t:[t];this.config.orderBy=s}else{const t=e;this.config.orderBy=t}return this}limit(e){return this.config.limit=e,this}returning(e=this.config.table[E.Symbol.Columns]){return this.config.returning=ee(e),this}getSQL(){return this.dialect.buildUpdateQuery(this.config)}toSQL(){const{typings:e,...t}=this.dialect.sqlToQuery(this.getSQL());return t}_prepare(e=!0){return this.session[e?"prepareOneTimeQuery":"prepareQuery"](this.dialect.sqlToQuery(this.getSQL()),this.config.returning,this.config.returning?"all":"run",!0,void 0,{type:"insert",tables:X(this.config.table)})}prepare(){return this._prepare(!1)}run=e=>this._prepare().run(e);all=e=>this._prepare().all(e);get=e=>this._prepare().get(e);values=e=>this._prepare().values(e);async execute(){return this.config.returning?this.all():this.run()}$dynamic(){return this}}class $e extends p{constructor(e){super($e.buildEmbeddedCount(e.source,e.filters).queryChunks),this.params=e,this.session=e.session,this.sql=$e.buildCount(e.source,e.filters)}sql;static[d]="SQLiteCountBuilderAsync";[Symbol.toStringTag]="SQLiteCountBuilderAsync";session;static buildEmbeddedCount(e,t){return a`(select count(*) from ${e}${a.raw(" where ").if(t)}${t})`}static buildCount(e,t){return a`select count(*) from ${e}${a.raw(" where ").if(t)}${t}`}then(e,t){return Promise.resolve(this.session.count(this.sql)).then(e,t)}catch(e){return this.then(void 0,e)}finally(e){return this.then(t=>(e?.(),t),t=>{throw e?.(),t})}}class ri{constructor(e,t,s,r,n,o,l,c){this.mode=e,this.fullSchema=t,this.schema=s,this.tableNamesMap=r,this.table=n,this.tableConfig=o,this.dialect=l,this.session=c}static[d]="SQLiteAsyncRelationalQueryBuilder";findMany(e){return this.mode==="sync"?new et(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e||{},"many"):new Ae(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e||{},"many")}findFirst(e){return this.mode==="sync"?new et(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e?{...e,limit:1}:{limit:1},"first"):new Ae(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e?{...e,limit:1}:{limit:1},"first")}}class Ae extends se{constructor(e,t,s,r,n,o,l,c,f){super(),this.fullSchema=e,this.schema=t,this.tableNamesMap=s,this.table=r,this.tableConfig=n,this.dialect=o,this.session=l,this.config=c,this.mode=f}static[d]="SQLiteAsyncRelationalQuery";mode;getSQL(){return this.dialect.buildRelationalQuery({fullSchema:this.fullSchema,schema:this.schema,tableNamesMap:this.tableNamesMap,table:this.table,tableConfig:this.tableConfig,queryConfig:this.config,tableAlias:this.tableConfig.tsName}).sql}_prepare(e=!1){const{query:t,builtQuery:s}=this._toSQL();return this.session[e?"prepareOneTimeQuery":"prepareQuery"](s,void 0,this.mode==="first"?"get":"all",!0,(r,n)=>{const o=r.map(l=>Re(this.schema,this.tableConfig,l,t.selection,n));return this.mode==="first"?o[0]:o})}prepare(){return this._prepare(!1)}_toSQL(){const e=this.dialect.buildRelationalQuery({fullSchema:this.fullSchema,schema:this.schema,tableNamesMap:this.tableNamesMap,table:this.table,tableConfig:this.tableConfig,queryConfig:this.config,tableAlias:this.tableConfig.tsName}),t=this.dialect.sqlToQuery(e.sql);return{query:e,builtQuery:t}}toSQL(){return this._toSQL().builtQuery}executeRaw(){return this.mode==="first"?this._prepare(!1).get():this._prepare(!1).all()}async execute(){return this.executeRaw()}}class et extends Ae{static[d]="SQLiteSyncRelationalQuery";sync(){return this.executeRaw()}}class pe extends se{constructor(e,t,s,r,n){super(),this.execute=e,this.getSQL=t,this.dialect=r,this.mapBatchResult=n,this.config={action:s}}static[d]="SQLiteRaw";config;getQuery(){return{...this.dialect.sqlToQuery(this.getSQL()),method:this.config.action}}mapResult(e,t){return t?this.mapBatchResult(e):e}_prepare(){return this}isResponseInArrayMode(){return!1}}class mt{constructor(e,t,s,r){this.resultKind=e,this.dialect=t,this.session=s,this._=r?{schema:r.schema,fullSchema:r.fullSchema,tableNamesMap:r.tableNamesMap}:{schema:void 0,fullSchema:{},tableNamesMap:{}},this.query={};const n=this.query;if(this._.schema)for(const[o,l]of Object.entries(this._.schema))n[o]=new ri(e,r.fullSchema,this._.schema,this._.tableNamesMap,r.fullSchema[o],l,t,s);this.$cache={invalidate:async o=>{}}}static[d]="BaseSQLiteDatabase";query;$with=(e,t)=>{const s=this;return{as:n=>(typeof n=="function"&&(n=n(new ft(s.dialect))),new Proxy(new st(n.getSQL(),t??("getSelectedFields"in n?n.getSelectedFields()??{}:{}),e,!0),new F({alias:e,sqlAliasedBehavior:"alias",sqlBehavior:"error"})))}};$count(e,t){return new $e({source:e,filters:t,session:this.session})}with(...e){const t=this;function s(c){return new Y({fields:c??void 0,session:t.session,dialect:t.dialect,withList:e})}function r(c){return new Y({fields:c??void 0,session:t.session,dialect:t.dialect,withList:e,distinct:!0})}function n(c){return new Xe(c,t.session,t.dialect,e)}function o(c){return new Ge(c,t.session,t.dialect,e)}function l(c){return new Ye(c,t.session,t.dialect,e)}return{select:s,selectDistinct:r,update:n,insert:o,delete:l}}select(e){return new Y({fields:e??void 0,session:this.session,dialect:this.dialect})}selectDistinct(e){return new Y({fields:e??void 0,session:this.session,dialect:this.dialect,distinct:!0})}update(e){return new Xe(e,this.session,this.dialect)}$cache;insert(e){return new Ge(e,this.session,this.dialect)}delete(e){return new Ye(e,this.session,this.dialect)}run(e){const t=typeof e=="string"?a.raw(e):e.getSQL();return this.resultKind==="async"?new pe(async()=>this.session.run(t),()=>t,"run",this.dialect,this.session.extractRawRunValueFromBatchResult.bind(this.session)):this.session.run(t)}all(e){const t=typeof e=="string"?a.raw(e):e.getSQL();return this.resultKind==="async"?new pe(async()=>this.session.all(t),()=>t,"all",this.dialect,this.session.extractRawAllValueFromBatchResult.bind(this.session)):this.session.all(t)}get(e){const t=typeof e=="string"?a.raw(e):e.getSQL();return this.resultKind==="async"?new pe(async()=>this.session.get(t),()=>t,"get",this.dialect,this.session.extractRawGetValueFromBatchResult.bind(this.session)):this.session.get(t)}values(e){const t=typeof e=="string"?a.raw(e):e.getSQL();return this.resultKind==="async"?new pe(async()=>this.session.values(t),()=>t,"values",this.dialect,this.session.extractRawValuesValueFromBatchResult.bind(this.session)):this.session.values(t)}transaction(e,t){return this.session.transaction(e,t)}}class ni{static[d]="Cache"}class pt extends ni{strategy(){return"all"}static[d]="NoopCache";async get(e){}async put(e,t,s,r){}async onMutate(e){}}async function tt(i,e){const t=`${i}-${JSON.stringify(e)}`,r=new TextEncoder().encode(t),n=await crypto.subtle.digest("SHA-256",r);return[...new Uint8Array(n)].map(c=>c.toString(16).padStart(2,"0")).join("")}class ai extends se{constructor(e){super(),this.resultCb=e}static[d]="ExecuteResultSync";async execute(){return this.resultCb()}sync(){return this.resultCb()}}class oi{constructor(e,t,s,r,n,o){this.mode=e,this.executeMethod=t,this.query=s,this.cache=r,this.queryMetadata=n,this.cacheConfig=o,r&&r.strategy()==="all"&&o===void 0&&(this.cacheConfig={enable:!0,autoInvalidate:!0}),this.cacheConfig?.enable||(this.cacheConfig=void 0)}static[d]="PreparedQuery";joinsNotNullableMap;async queryWithCache(e,t,s){if(this.cache===void 0||h(this.cache,pt)||this.queryMetadata===void 0)try{return await s()}catch(r){throw new k(e,t,r)}if(this.cacheConfig&&!this.cacheConfig.enable)try{return await s()}catch(r){throw new k(e,t,r)}if((this.queryMetadata.type==="insert"||this.queryMetadata.type==="update"||this.queryMetadata.type==="delete")&&this.queryMetadata.tables.length>0)try{const[r]=await Promise.all([s(),this.cache.onMutate({tables:this.queryMetadata.tables})]);return r}catch(r){throw new k(e,t,r)}if(!this.cacheConfig)try{return await s()}catch(r){throw new k(e,t,r)}if(this.queryMetadata.type==="select"){const r=await this.cache.get(this.cacheConfig.tag??await tt(e,t),this.queryMetadata.tables,this.cacheConfig.tag!==void 0,this.cacheConfig.autoInvalidate);if(r===void 0){let n;try{n=await s()}catch(o){throw new k(e,t,o)}return await this.cache.put(this.cacheConfig.tag??await tt(e,t),n,this.cacheConfig.autoInvalidate?this.queryMetadata.tables:[],this.cacheConfig.tag!==void 0,this.cacheConfig.config),n}return r}try{return await s()}catch(r){throw new k(e,t,r)}}getQuery(){return this.query}mapRunResult(e,t){return e}mapAllResult(e,t){throw new Error("Not implemented")}mapGetResult(e,t){throw new Error("Not implemented")}execute(e){return this.mode==="async"?this[this.executeMethod](e):new ai(()=>this[this.executeMethod](e))}mapResult(e,t){switch(this.executeMethod){case"run":return this.mapRunResult(e,t);case"all":return this.mapAllResult(e,t);case"get":return this.mapGetResult(e,t)}}}class li{constructor(e){this.dialect=e}static[d]="SQLiteSession";prepareOneTimeQuery(e,t,s,r,n,o,l){return this.prepareQuery(e,t,s,r,n,o,l)}run(e){const t=this.dialect.sqlToQuery(e);try{return this.prepareOneTimeQuery(t,void 0,"run",!1).run()}catch(s){throw new Me({cause:s,message:`Failed to run the query '${t.sql}'`})}}extractRawRunValueFromBatchResult(e){return e}all(e){return this.prepareOneTimeQuery(this.dialect.sqlToQuery(e),void 0,"run",!1).all()}extractRawAllValueFromBatchResult(e){throw new Error("Not implemented")}get(e){return this.prepareOneTimeQuery(this.dialect.sqlToQuery(e),void 0,"run",!1).get()}extractRawGetValueFromBatchResult(e){throw new Error("Not implemented")}values(e){return this.prepareOneTimeQuery(this.dialect.sqlToQuery(e),void 0,"run",!1).values()}async count(e){return(await this.values(e))[0][0]}extractRawValuesValueFromBatchResult(e){throw new Error("Not implemented")}}class ui extends mt{constructor(e,t,s,r,n=0){super(e,t,s,r),this.schema=r,this.nestedIndex=n}static[d]="SQLiteTransaction";rollback(){throw new Ws}}class ci extends li{constructor(e,t,s,r,n={}){super(t),this.client=e,this.schema=s,this.batchCLient=r,this.logger=n.logger??new Lt,this.cache=n.cache??new pt}static[d]="SQLiteRemoteSession";logger;cache;prepareQuery(e,t,s,r,n,o,l){return new hi(this.client,e,this.logger,this.cache,o,l,t,s,r,n)}async batch(e){const t=[],s=[];for(const n of e){const o=n._prepare(),l=o.getQuery();t.push(o),s.push({sql:l.sql,params:l.params,method:l.method})}return(await this.batchCLient(s)).map((n,o)=>t[o].mapResult(n,!0))}async transaction(e,t){const s=new Ke("async",this.dialect,this,this.schema);await this.run(a.raw(`begin${t?.behavior?" "+t.behavior:""}`));try{const r=await e(s);return await this.run(a`commit`),r}catch(r){throw await this.run(a`rollback`),r}}extractRawAllValueFromBatchResult(e){return e.rows}extractRawGetValueFromBatchResult(e){return e.rows[0]}extractRawValuesValueFromBatchResult(e){return e.rows}}class Ke extends ui{static[d]="SQLiteProxyTransaction";async transaction(e){const t=`sp${this.nestedIndex}`,s=new Ke("async",this.dialect,this.session,this.schema,this.nestedIndex+1);await this.session.run(a.raw(`savepoint ${t}`));try{const r=await e(s);return await this.session.run(a.raw(`release savepoint ${t}`)),r}catch(r){throw await this.session.run(a.raw(`rollback to savepoint ${t}`)),r}}}class hi extends oi{constructor(e,t,s,r,n,o,l,c,f,u){super("async",c,t,r,n,o),this.client=e,this.logger=s,this.fields=l,this._isResponseInArrayMode=f,this.customResultMapper=u,this.customResultMapper=u,this.method=c}static[d]="SQLiteProxyPreparedQuery";method;getQuery(){return{...this.query,method:this.method}}async run(e){const t=me(this.query.params,e??{});return this.logger.logQuery(this.query.sql,t),await this.queryWithCache(this.query.sql,t,async()=>await this.client(this.query.sql,t,"run"))}mapAllResult(e,t){return t&&(e=e.rows),!this.fields&&!this.customResultMapper?e:this.customResultMapper?this.customResultMapper(e):e.map(s=>We(this.fields,s,this.joinsNotNullableMap))}async all(e){const{query:t,logger:s,client:r}=this,n=me(t.params,e??{});s.logQuery(t.sql,n);const{rows:o}=await this.queryWithCache(t.sql,n,async()=>await r(t.sql,n,"all"));return this.mapAllResult(o)}async get(e){const{query:t,logger:s,client:r}=this,n=me(t.params,e??{});s.logQuery(t.sql,n);const o=await this.queryWithCache(t.sql,n,async()=>await r(t.sql,n,"get"));return this.mapGetResult(o.rows)}mapGetResult(e,t){t&&(e=e.rows);const s=e;if(!this.fields&&!this.customResultMapper)return s;if(s)return this.customResultMapper?this.customResultMapper([e]):We(this.fields,s,this.joinsNotNullableMap)}async values(e){const t=me(this.query.params,e??{});return this.logger.logQuery(this.query.sql,t),(await this.queryWithCache(this.query.sql,t,async()=>await this.client(this.query.sql,t,"values"))).rows}isResponseInArrayMode(){return this._isResponseInArrayMode}}class di extends mt{static[d]="SqliteRemoteDatabase";async batch(e){return this.session.batch(e)}}function fi(i,e,t){const s=new Hs({casing:t?.casing});let r,n,o,l={};e&&(typeof e=="function"?(o=e,l={}):(o=void 0,l=e),l.logger===!0?r=new Qt:l.logger!==!1&&(r=l.logger,n=l.cache));let c;if(l.schema){const y=is(l.schema,os);c={fullSchema:l.schema,schema:y.tables,tableNamesMap:y.tableNamesMap}}const f=new ci(i,s,c,o,{logger:r,cache:n}),u=new di("async",s,f,c);return u.$cache=n,u.$cache&&(u.$cache.invalidate=n?.onMutate),u}let ye,oe;async function K(){return ye?{database:ye,sqlite:oe}:(oe=await we.load("sqlite:sqlite.db"),ye=fi(async(i,e,t)=>{let s=[],r=[];if(mi(i))s=await oe.select(i,e).catch(n=>(console.error("SQL Error:",n),[]));else return s=await oe.execute(i,e).catch(n=>(console.error("SQL Error:",n),[])),{rows:[]};return s=s.map(n=>Object.values(n)),r=t==="all"?s:s[0],{rows:r}},{logger:!1,casing:"snake_case"}),{database:ye,sqlite:oe})}function mi(i){return/^\s*SELECT\b/i.test(i)}const j=ht("user_modules",{id:ue().primaryKey({autoIncrement:!0}),moduleId:W("module_id").notNull(),color:W().notNull().default("#FFFFFF"),displayOrder:ue("display_order").notNull().default(0)}),w=ht("user_links",{id:ue().primaryKey({autoIncrement:!0}),linkId:W("link_id").notNull(),type:W({enum:["shortcut","label"]}).notNull(),displayOrder:ue("display_order").notNull().default(0),icon:W(),color:W().notNull().default("#FFFFFF"),parameters:W({mode:"json"}).$type(),moduleId:W("module_id").notNull()}),gi=wt({modules:[],moduleCards:[],shortcuts:[],async loadModuleCards(){const{database:i}=await K(),e=await i.select().from(j).orderBy(j.displayOrder),t=await i.select().from(w).where(v(w.type,"label")).orderBy(w.displayOrder);this.moduleCards=await Promise.all(e.map(async s=>{const r=this.modules.find(l=>l.id===s.moduleId),n=t.filter(l=>l.moduleId===s.moduleId),o=await Promise.all(n.map(async l=>({component:(await r.links.find(u=>u.id===l.linkId).call())?.default,parameters:l.parameters??{}})));return{name:r.name,moduleId:s.moduleId,color:s.color,displayOrder:s.displayOrder,labels:o}}))},async loadShortcuts(){const{database:i}=await K(),e=await i.select().from(w).where(v(w.type,"shortcut")).orderBy(w.displayOrder),t=new Map(this.modules.map(n=>[n.id,n])),s=[],r=[];for(const n of e){const o=t.get(n.moduleId);if(!o){r.push(n.id);continue}const l=o.links.find(c=>c.type==="shortcut"&&c.id===n.linkId);if(!l){r.push(n.id);continue}s.push({id:n.id,moduleId:n.moduleId,linkId:n.linkId,icon:n.icon,color:n.color,displayOrder:n.displayOrder,call:l.call,parameters:n.parameters??{}})}r.length>0&&await i.delete(w).where(lt(w.id,r)),this.shortcuts=s},async addModuleCard(i,e,t){t||(t=this.moduleCards[this.moduleCards.length-1]?.displayOrder+1||0),e||(e="#FFFFFF");const{database:s}=await K();(await s.select().from(j).where(v(j.displayOrder,t))).length>0&&s.update(j).set({displayOrder:a`${j.displayOrder} + 1`}).where(be(j.displayOrder,t)),await s.insert(j).values({moduleId:i,color:e,displayOrder:t}),await this.loadModuleCards()},async removeModuleCard(i){const{database:e}=await K();await e.delete(j).where(v(j.moduleId,i)),await e.delete(w).where(v(w.moduleId,i)),await this.loadModuleCards(),await this.loadShortcuts()},getLabels(i){return this.modules.find(e=>e.id===i)?.links.filter(e=>e.type==="label").sort((e,t)=>e.name.localeCompare(t.name))||[]},getActions(i){return this.modules.find(e=>e.id===i)?.links.filter(e=>e.type==="shortcut").sort((e,t)=>e.name.localeCompare(t.name))||[]},async getEnabledLabels(i){const{database:e}=await K();return(await e.select().from(w).where(H(v(w.moduleId,i),v(w.type,"label"))).orderBy(w.displayOrder)).map(s=>({id:s.id,linkId:s.linkId,parameters:s.parameters}))},async addLabel(i,e,t,s){const{database:r}=await K();(await r.select().from(w).where(H(v(w.moduleId,i),v(w.displayOrder,s)))).length>0&&await r.update(w).set({displayOrder:a`${w.displayOrder} + 1`}).where(H(v(w.moduleId,i),be(w.displayOrder,s))),await r.insert(w).values({linkId:e,type:"label",displayOrder:s,parameters:t,moduleId:i}),await this.loadModuleCards()},async addShortcut(i,e,t,s,r,n){n||(n=this.shortcuts[this.shortcuts.length-1]?.displayOrder+1||0),r||(r="#FFFFFF");const{database:o}=await K();(await o.select().from(w).where(H(v(w.moduleId,i),v(w.displayOrder,n)))).length>0&&o.update(w).set({displayOrder:a`${w.displayOrder} + 1`}).where(H(v(w.moduleId,i),be(w.displayOrder,n))),await o.insert(w).values({linkId:e,type:"shortcut",displayOrder:n,icon:s,color:r,parameters:t,moduleId:i}),await this.loadShortcuts()},async removeLink(i){const{database:e}=await K();await e.delete(w).where(v(w.id,i)),await this.loadShortcuts()},async editModuleCard(i,e){const{database:t}=await K(),s={};e.color!==void 0&&(s.color=e.color),e.displayOrder!==void 0&&(s.displayOrder=e.displayOrder),Object.keys(s).length!==0&&(await t.update(j).set(s).where(v(j.moduleId,i)),await this.loadModuleCards())},async editShortcut(i,e){const{database:t}=await K(),s={};e.icon!==void 0&&(s.icon=e.icon),e.color!==void 0&&(s.color=e.color),e.displayOrder!==void 0&&(s.displayOrder=e.displayOrder),e.parameters!==void 0&&(s.parameters=e.parameters),Object.keys(s).length!==0&&(await t.update(w).set(s).where(v(w.id,i)),await this.loadShortcuts())}});export{a,fe as b,v as e,ue as i,gi as m,As as r,ht as s,W as t,K as u};
